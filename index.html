<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://openlayers.org/en/v3.20.1/css/ol.css" type="text/css">
    <style>
        body, html {
            padding:0;
            margin:0;
        }
        .map {
            height: 100vh;
            width: 100%;
        }
    </style>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.1.1.slim.min.js" integrity="sha384-A7FZj7v+d/sdmMqp/nOQwliLvUsJfDHW+k9Omg/a/EheAdgtzNs3hpfag6Ed950n" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ol3/3.21.0-beta.2/ol-debug.js" type="text/javascript"></script>
    <title>OpenLayers 3 example</title>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <div class="col-md-9">
            <div id="map" class="map"></div>
        </div>
        <div id="sidebar" class="col-md-3">
            <div id="side">

            </div>
            <!--input type="range" id="tijd" max="1500000000000" min="1000000000000" step="86400000"-->
            <input type="range" id="tijd" max="2017" min="1900" step="1" value="2017">

            <div id="datum">2017</div>
        </div>
    </div>
</div>
<script type="text/javascript">
    var GELDIGHEID = new Date();
    var NOW = new Date(GELDIGHEID.getTime()+1);
    var zoom = 15;
    var center= ol.proj.fromLonLat([4.9, 52.35]);
    if (window.location.hash !== '') {
        var hash = window.location.hash.replace('#', '');
        var parts = hash.split(';');
        if (parts.length === 3) {
            zoom = parseInt(parts[0], 10);
            center = [
                parseFloat(parts[1]),
                parseFloat(parts[2])
            ];
        }
    }

    var unselectedStyle = new ol.style.Style({
        fill: new ol.style.Fill({color: 'rgba(204,204,204,0.6)'}),
        stroke: new ol.style.Stroke({color: '#969696', width: 1})
    });
    var filteredStyle = new ol.style.Style({
        fill: new ol.style.Fill({color: 'rgba(150,150,150,0.3)'}),
        stroke: new ol.style.Stroke({color: '#7a0177', width: 1})
    });

    var checkGeldigheid = function(feature) {
        var geldig = false;
        var begin = feature.get('begindatumtijdvakgeldigheid');
        var eind = feature.get('einddatumtijdvakgeldigheid');
        var beginDatum = begin===undefined?null:new Date(begin);
        var eindDatum = eind===undefined?NOW:new Date(eind);
        if(beginDatum<=GELDIGHEID&&eindDatum>GELDIGHEID) geldig = true;

        return geldig;
    };

    function createStyle(feature, resolution) {
        var geldig = checkGeldigheid(feature);
        if(geldig) {
            return filteredStyle;
        }

    }
    var bagpanden = new ol.layer.VectorTile({
        source: new ol.source.VectorTile({
            attributions: 'BAG data: Â© <a href="https://www.kadaster.nl/bag">Kadaster</a> ' +
            'Client: <a href="https://research.geodan.nl/">' +
            'Geodan Research</a>',
            format: new ol.format.MVT({
                featureClass: ol.Feature
            }),
            tileGrid: ol.tilegrid.createXYZ({maxZoom: 22}),
            tilePixelRatio: 1.000000001,
            url: '//research.geodan.nl/service/geoserver/gwc/service/tms/1.0.0/research%3Apand@World_3857@pbf/' +
            '{z}/{x}/{-y}.pbf'
        }),
        style: createStyle

    });
    var map = new ol.Map({
    layers: [
        new ol.layer.Tile({
            source: new ol.source.OSM({
                url: 'https://saturnus.geodan.nl/mapproxy/osm/tiles/osmgrayscale_EPSG900913/{z}/{x}/{y}.png?origin=nw'
            })
        }),
        bagpanden
    ],
        target: 'map',
        view: new ol.View({
            center: center,
            zoom: zoom
        })
    });



     var displayFeatureInfo = function(pixel) {

         map.forEachFeatureAtPixel(pixel, function(feature, layer) {
             ID= feature.get('identificatie');
             layer.changed();
         });

     };

     map.on('click', function(evt) {
         var pixel = evt.pixel;
         displayFeatureInfo(pixel);

     });


    $('#tijd').on('input',function (d,e) {
        GELDIGHEID = new Date('01/01/'+d.target.value);


        bagpanden.changed();
        var e =document.getElementById('datum');
        e.innerHTML =d.target.value;
    })
    map.on('moveend', function() {
        var view = map.getView();
        var center = view.getCenter();
        window.location.hash =
            view.getZoom() + ';' + center[0] + ';' + center[1];
    });
</script>
</body>
</html>